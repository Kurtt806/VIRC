<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>VIRC-Controler Lightning RC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="VIRC LED">
  <meta name="theme-color" content="#1e1e1e">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon.png">

  <!-- Font ng·∫ßu h∆°n -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1e1e1e;
      color: #e0e0e0;
      padding: 10px;
      margin: 0;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: #2b2b2b;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.2);
    }

    .header-title {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      margin-bottom: 20px;
    }

    .header-title img {
      height: 48px;
      width: auto;
      border-radius: 6px;
    }

    .header-title h2 {
      font-family: 'Orbitron', sans-serif;
      color: #ffd700;
      font-size: 1.8rem;
      text-shadow: 2px 2px #000;
      margin: 0;
    }

    button {
      background-color: #2c2c2c;
      color: #e0e0e0;
      border: 1px solid #ffd700;
      margin: 5px 0;
      padding: 10px 15px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 6px;
      width: 100%;
      transition: background 0.2s, color 0.2s;
    }

    button:hover {
      background-color: #ffd700;
      color: #000;
    }

    input[type=number],
    input[type=file] {
      background: #1a1a1a;
      color: #fff;
      border: 1px solid #444;
      padding: 8px;
      font-size: 1rem;
      border-radius: 5px;
      width: 100%;
      margin-top: 8px;
    }

    #uploadBox {
      border: 2px dashed #ffd700;
      background: #2c2c2c;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      margin-top: 15px;
      border-radius: 8px;
    }

    #uploadBox.dragover {
      border-color: #fff176;
      background: #3a3a3a;
    }

    #uploadStatus {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
      color: #ffd700;
    }

    .progress-bar-container {
      background: #333;
      border-radius: 6px;
      overflow: hidden;
      height: 16px;
      margin-top: 4px;
    }

    .progress-bar {
      height: 100%;
      background-color: #ffd700;
      width: 0%;
      transition: width 0.3s;
    }

    .logo-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .logo-overlay img {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90%;
      opacity: 0.05;
    }

    #consoleBox {
      display: block;
      white-space: pre-wrap;
    }

    @media (max-width: 768px) {
      .two-column {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header-title">
      <img src="icon.png" alt="logo">
      <h2>VIRC- Controler Lightning RC</h2>
    </div>

    <div class="two-column" style="display: grid; grid-template-columns: 3fr 2fr; gap: 20px; align-items: start;">
      <div id="effectControl">
        <div id="effectButtons"></div>
        <input type="number" id="brightnessInput" placeholder="0-255">
        <button onclick="setBrightness()">‚ú® Set Brightness</button>
      </div>

      <div id="uploadArea">
        <div id="uploadBox">üìÇ K√©o th·∫£ file config.cfg v√†o ƒë√¢y ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn</div>
        <input type="file" id="configFile" name="configFile" style="display:none;">
        <div id="uploadStatus"></div>
      </div>
    </div>

    <p><b>H·ªá th·ªëng:</b></p>
    <div id="sysinfo"
      style="margin-top:15px; padding:15px; background:#1f1f1f; border:1px solid #444; border-radius:10px;">
      <h3 style="color:#ffd700; margin-bottom:10px;">üìü Th√¥ng tin h·ªá th·ªëng</h3>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <p>Chip ID: <span id="chip_id">---</span></p>
        <p>MAC: <span id="mac_addr">---</span></p>
        <p>Flash Size: <span id="flash_size">---</span></p>
        <div class="progress-bar-container">
          <div id="flash_progress" class="progress-bar"></div>
        </div>
        <p>Free Heap: <span id="heap_free">---</span></p>
        <div class="progress-bar-container">
          <div id="heap_progress" class="progress-bar"></div>
        </div>
        <p>CPU Freq: <span id="cpu_freq">---</span></p>
        <p>Uptime: <span id="uptime">---</span></p>
      </div>
    </div>

    <p><b>Console Serial:</b></p>
    <pre id="consoleBox"
      style="background:#111; color:#0f0; padding:10px; height:150px; overflow:auto; border-radius:6px;"></pre>
  </div>

  <div class="logo-overlay" id="logoLayer">
    <img src="logo_vi3d.jpeg" alt="VI3D Logo">
  </div>

  <script>
    const ws = new WebSocket(`ws://${location.host}/ws`);

    ws.onopen = () => {
      appendToConsole("‚úÖ WebSocket ƒë√£ k·∫øt n·ªëi");
    };

    ws.onerror = (err) => {
      appendToConsole("‚ùå L·ªói WebSocket: " + err.message);
    };

    ws.onmessage = e => {
      if (e.data.startsWith("[LOG]")) {
        appendToConsole(e.data.replace("[LOG]", ""));
        return;
      }

      if (e.data.startsWith("[SYSINFO]")) {
        const sysData = JSON.parse(e.data.replace("[SYSINFO]", ""));
        document.getElementById("chip_id").innerText = sysData.chip_id || "N/A";
        document.getElementById("mac_addr").innerText = sysData.mac || "N/A";

        const flashKB = sysData.flash_size;
        const heapFree = sysData.heap_free;
        const heapMax = 300000;

        document.getElementById("flash_size").innerText = flashKB + " KB";
        document.getElementById("flash_progress").style.width = Math.min(100, (flashKB / 4096) * 100) + "%";

        document.getElementById("heap_free").innerText = heapFree + " B";
        document.getElementById("heap_progress").style.width = Math.min(100, (heapFree / heapMax) * 100) + "%";

        document.getElementById("cpu_freq").innerText = sysData.cpu_freq + " MHz";
        document.getElementById("uptime").innerText = sysData.uptime;
        return;
      }

      if (e.data.startsWith("[EFFECT_LIST]")) {
        const effects = e.data.replace("[EFFECT_LIST]", "").split(",");
        const btnContainer = document.getElementById("effectButtons");
        btnContainer.innerHTML = "";
        effects.forEach(effect => {
          const btn = document.createElement("button");
          btn.innerText = `‚ú® ${effect}`;
          btn.onclick = () => sendCommand("SET:" + effect);
          btnContainer.appendChild(btn);
        });
        return;
      }
    };

    function sendCommand(cmd) {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(cmd);
        appendToConsole(`[CMD] ${cmd}`);
      } else {
        appendToConsole(`[ERR] WebSocket ch∆∞a s·∫µn s√†ng`);
      }
    }

    function appendToConsole(line) {
      const logBox = document.getElementById("consoleBox");
      logBox.textContent += line + "\n";
      logBox.scrollTop = logBox.scrollHeight;
    }

    function setBrightness() {
      const b = document.getElementById("brightnessInput").value;
      sendCommand("SET_BRIGHTNESS:" + b);
    }

    const uploadBox = document.getElementById("uploadBox");
    const fileInput = document.getElementById("configFile");

    uploadBox.addEventListener("click", () => fileInput.click());
    uploadBox.addEventListener("dragover", e => {
      e.preventDefault();
      uploadBox.classList.add("dragover");
    });
    uploadBox.addEventListener("dragleave", () => {
      uploadBox.classList.remove("dragover");
    });
    uploadBox.addEventListener("drop", e => {
      e.preventDefault();
      uploadBox.classList.remove("dragover");
      if (e.dataTransfer.files.length) {
        uploadFile(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener("change", () => {
      if (fileInput.files.length) {
        uploadFile(fileInput.files[0]);
      }
    });

    function uploadFile(file) {
      const formData = new FormData();
      formData.append("configFile", file);
      fetch("/upload", { method: "POST", body: formData })
        .then(r => r.text())
        .then(result => {
          document.getElementById("uploadStatus").style.color = "green";
          document.getElementById("uploadStatus").innerText = "‚úÖ T·∫£i l√™n th√†nh c√¥ng!";
          // setTimeout(() => { document.getElementById("uploadStatus").innerText = ""; }, 3000);

          if (ws.readyState === WebSocket.OPEN) {
            ws.send("REFRESH_EFFECT_LIST");
          }
        })
        .catch(error => {
          document.getElementById("uploadStatus").style.color = "red";
          document.getElementById("uploadStatus").innerText = "‚ùå T·∫£i l√™n th·∫•t b·∫°i!";
        });
    }

    function loadEffectButtons() {
      fetch('/effect_list')
        .then(res => res.json())
        .then(effects => {
          const container = document.getElementById("effectButtons");
          container.innerHTML = "";
          effects.forEach(effect => {
            const btn = document.createElement("button");
            btn.innerText = `‚ú® ${effect}`;
            btn.onclick = () => sendCommand("SET:" + effect);
            container.appendChild(btn);
          });
        })
        .catch(err => {
          console.error("L·ªói t·∫£i hi·ªáu ·ª©ng:", err);
          appendToConsole("[ERR] Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch hi·ªáu ·ª©ng");
        });
    }

    window.addEventListener("load", loadEffectButtons);
  </script>
</body>

</html>
